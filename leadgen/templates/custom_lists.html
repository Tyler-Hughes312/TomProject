<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Lists - Lead Generator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="/dashboard" class="nav-brand">📊 Lead Generator</a>
            <div class="nav-links">
                <a href="/dashboard" class="nav-link">Dashboard</a>
                <a href="/list-generator" class="nav-link">List Generator</a>
                <a href="/saved-lists" class="nav-link">Saved Lists</a>
                <a href="/custom-lists" class="nav-link active">Custom Lists</a>
                <a href="/profile" class="nav-link">Profile</a>
                <a href="/logout" class="nav-link">Logout</a>
            </div>
        </div>
    </nav>
    
    <main class="main-content">
        <div class="custom-lists-container">
            <header class="page-header">
                <h1>📝 Custom Lists</h1>
                <p>Create and manage your own custom business lists</p>
            </header>
            
            <div class="lists-section">
                <div class="lists-header">
                    <h2>Your Custom Lists</h2>
                    <div class="lists-actions">
                        <button id="createListBtn" class="create-button">➕ Create New List</button>
                        <button id="refreshListsBtn" class="refresh-button">🔄 Refresh</button>
                    </div>
                </div>
                
                <div id="customListsContainer" class="lists-grid">
                    <div class="loading-state">
                        <p>Loading your custom lists...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Create List Modal -->
    <div id="createListModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>📝 Create Custom List</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="createListForm">
                    <div class="form-group">
                        <label for="listName">List Name *</label>
                        <input type="text" id="listName" name="listName" required>
                    </div>
                    <div class="form-group">
                        <label for="listDescription">Description</label>
                        <textarea id="listDescription" name="listDescription" rows="3"></textarea>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="cancel-button">Cancel</button>
                        <button type="submit" class="save-button">Create List</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- List Details Modal -->
    <div id="listDetailsModal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h3 id="listDetailsTitle">List Details</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div id="listDetailsContent">
                    <p>Loading list details...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Save Contact Modal -->
    <div id="saveContactModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>💾 Save Contact</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="saveContactForm">
                    <div class="form-group">
                        <label for="contactListType">Save to:</label>
                        <select id="contactListType" name="listType" required>
                            <option value="">Select list type</option>
                            <option value="saved">Saved List</option>
                            <option value="custom">Custom List</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="contactListId">Select List:</label>
                        <select id="contactListId" name="listId" required>
                            <option value="">Select a list</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="contactNotes">Notes (optional):</label>
                        <textarea id="contactNotes" name="notes" rows="3"></textarea>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="cancel-button">Cancel</button>
                        <button type="submit" class="save-button">Save Contact</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script>
        let customLists = [];
        let savedLists = [];
        let currentBusinessId = null;
        
        // Load custom lists
        async function loadCustomLists() {
            try {
                const response = await fetch('/api/v1/custom-lists/');
                const data = await response.json();
                
                if (data.error) {
                    console.error('Error loading custom lists:', data.error);
                    return;
                }
                
                customLists = data.results;
                displayCustomLists(data.results);
                
            } catch (error) {
                console.error('Error loading custom lists:', error);
            }
        }
        
        // Load saved lists for contact saving
        async function loadSavedLists() {
            try {
                const response = await fetch('/api/v1/saved-lists/');
                const data = await response.json();
                
                if (!data.error) {
                    savedLists = data.results;
                }
            } catch (error) {
                console.error('Error loading saved lists:', error);
            }
        }
        
        // Display custom lists
        function displayCustomLists(lists) {
            const container = document.getElementById('customListsContainer');
            
            if (lists.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No custom lists yet</h3>
                        <p>Create your first custom list to organize your business contacts</p>
                        <button class="action-button primary" onclick="document.getElementById('createListBtn').click()">📝 Create List</button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = lists.map(list => `
                <div class="list-card">
                    <div class="list-header">
                        <h3>${list.name}</h3>
                        <div class="list-meta">
                            <span class="list-count">${list.business_count} businesses</span>
                            <span class="list-date">${new Date(list.created_at).toLocaleDateString()}</span>
                        </div>
                    </div>
                    <div class="list-description">
                        <p>${list.description || 'No description'}</p>
                    </div>
                    <div class="list-actions">
                        <button class="view-list-button" data-list-id="${list.id}">
                            👁️ View List
                        </button>
                        <button class="edit-list-button" data-list-id="${list.id}">
                            ✏️ Edit
                        </button>
                        <button class="delete-list-button" data-list-id="${list.id}">
                            🗑️ Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // Handle create list button
        document.getElementById('createListBtn').addEventListener('click', () => {
            document.getElementById('createListModal').style.display = 'block';
        });
        
        // Handle create list form
        document.getElementById('createListForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const listData = Object.fromEntries(formData);
            
            try {
                const response = await fetch('/api/v1/custom-lists/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: listData.listName,
                        description: listData.listDescription
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Custom list created successfully!');
                    document.getElementById('createListModal').style.display = 'none';
                    document.getElementById('createListForm').reset();
                    loadCustomLists();
                } else {
                    alert(result.error || 'Failed to create list');
                }
                
            } catch (error) {
                console.error('Create list error:', error);
                alert('Failed to create list');
            }
        });
        
        // Handle view list button
        document.addEventListener('click', async (e) => {
            if (e.target.classList.contains('view-list-button')) {
                const listId = e.target.dataset.listId;
                const list = customLists.find(l => l.id == listId);
                
                if (list) {
                    showListDetails(list);
                }
            }
        });
        
        // Handle delete list button
        document.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-list-button')) {
                const listId = e.target.dataset.listId;
                
                if (confirm('Are you sure you want to delete this list?')) {
                    try {
                        const response = await fetch(`/api/v1/custom-lists/${listId}/`, {
                            method: 'DELETE'
                        });
                        
                        if (response.ok) {
                            alert('List deleted successfully!');
                            loadCustomLists();
                        } else {
                            alert('Error deleting list');
                        }
                    } catch (error) {
                        console.error('Delete error:', error);
                        alert('Error deleting list');
                    }
                }
            }
        });
        
        // Show list details
        function showListDetails(list) {
            document.getElementById('listDetailsTitle').textContent = list.name;
            
            document.getElementById('listDetailsContent').innerHTML = `
                <div class="list-details">
                    <div class="list-info">
                        <h4>List Information</h4>
                        <p><strong>Name:</strong> ${list.name}</p>
                        <p><strong>Description:</strong> ${list.description || 'No description'}</p>
                        <p><strong>Created:</strong> ${new Date(list.created_at).toLocaleString()}</p>
                        <p><strong>Businesses:</strong> ${list.business_count}</p>
                    </div>
                    
                    <div class="businesses-list">
                        <h4>Businesses in this list:</h4>
                        <div id="listBusinesses" class="businesses-grid">
                            <p>Loading businesses...</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('listDetailsModal').style.display = 'block';
            
            // Load businesses for this list
            loadListBusinesses(list.id);
        }
        
        // Load businesses for a specific list
        async function loadListBusinesses(listId) {
            try {
                const response = await fetch(`/api/v1/custom-lists/${listId}/businesses/`);
                const data = await response.json();
                
                if (data.error) {
                    document.getElementById('listBusinesses').innerHTML = '<p>Error loading businesses</p>';
                    return;
                }
                
                const businesses = data.results || [];
                
                if (businesses.length === 0) {
                    document.getElementById('listBusinesses').innerHTML = '<p>No businesses in this list yet</p>';
                    return;
                }
                
                document.getElementById('listBusinesses').innerHTML = businesses.map(business => `
                    <div class="business-item">
                        <h5>${business.name}</h5>
                        <p>📍 ${business.address || 'No address'}</p>
                        <p>📞 ${business.phone || 'No phone'}</p>
                        <div class="business-actions">
                            <button class="save-contact-button" data-business-id="${business.id}">
                                ➕ Save to Another List
                            </button>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading list businesses:', error);
                document.getElementById('listBusinesses').innerHTML = '<p>Error loading businesses</p>';
            }
        }
        
        // Handle save contact button
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('save-contact-button')) {
                currentBusinessId = e.target.dataset.businessId;
                showSaveContactModal();
            }
        });
        
        // Show save contact modal
        function showSaveContactModal() {
            // Populate list options
            const listTypeSelect = document.getElementById('contactListType');
            const listIdSelect = document.getElementById('contactListId');
            
            listTypeSelect.addEventListener('change', () => {
                const listType = listTypeSelect.value;
                listIdSelect.innerHTML = '<option value="">Select a list</option>';
                
                if (listType === 'saved') {
                    savedLists.forEach(list => {
                        const option = document.createElement('option');
                        option.value = list.id;
                        option.textContent = list.name;
                        listIdSelect.appendChild(option);
                    });
                } else if (listType === 'custom') {
                    customLists.forEach(list => {
                        const option = document.createElement('option');
                        option.value = list.id;
                        option.textContent = list.name;
                        listIdSelect.appendChild(option);
                    });
                }
            });
            
            document.getElementById('saveContactModal').style.display = 'block';
        }
        
        // Handle save contact form
        document.getElementById('saveContactForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            try {
                const response = await fetch('/api/v1/contacts/save/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        business_id: currentBusinessId,
                        list_type: data.listType,
                        list_id: data.listId,
                        notes: data.notes
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Contact saved successfully!');
                    document.getElementById('saveContactModal').style.display = 'none';
                    document.getElementById('saveContactForm').reset();
                } else {
                    alert(result.error || 'Failed to save contact');
                }
                
            } catch (error) {
                console.error('Save contact error:', error);
                alert('Failed to save contact');
            }
        });
        
        // Handle refresh button
        document.getElementById('refreshListsBtn').addEventListener('click', () => {
            loadCustomLists();
        });
        
        // Modal functionality
        document.querySelectorAll('.close').forEach(closeBtn => {
            closeBtn.addEventListener('click', (e) => {
                const modal = e.target.closest('.modal');
                modal.style.display = 'none';
            });
        });
        
        document.querySelectorAll('.cancel-button').forEach(cancelBtn => {
            cancelBtn.addEventListener('click', (e) => {
                const modal = e.target.closest('.modal');
                modal.style.display = 'none';
            });
        });
        
        // Close modal when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });
        
        // Load data when page loads
        loadCustomLists();
        loadSavedLists();
    </script>
</body>
</html>
